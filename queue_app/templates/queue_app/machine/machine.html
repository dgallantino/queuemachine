{% extends "queue_app/base.html" %}
{% load static %}
{% block title %}Machine{% endblock %}
{% block stylesheet %}
	<link href="{% static 'queue_app/core/css/machine.css'%}" rel="stylesheet" type="text/css">
	<link href="{% static 'queue_app/core/css/simple-sidebar.css'%}" rel="stylesheet" type="text/css">
{% endblock %}
{% block head_script %}
<script type="text/javascript">

</script>
{% endblock %}
{% block javascript %}
{#<script src="{% static 'queue_app/core/js/cookies_manager.js' %}"></script>#}
<script type="text/javascript">

$("#menu-toggle").click(function(e) {
    e.preventDefault();
    $(".wrapper").toggleClass("toggled");
    $("#button-icon").toggleClass("flip")    
});

function PrintTicket(data) {
    var contents = data;
    var frame1 = document.createElement('iframe');
    frame1.name = "frame1";
    frame1.style.position = "absolute";
    frame1.style.top = "-1000000px";
    document.body.appendChild(frame1);
    var frameDoc = frame1.contentWindow ? frame1.contentWindow : frame1.contentDocument.document ? frame1.contentDocument.document : frame1.contentDocument;
    frameDoc.document.open();
    frameDoc.document.write('<html><head><title>DIV Contents</title>');
    frameDoc.document.write('</head><body>');
    frameDoc.document.write(contents);
    frameDoc.document.write('</body></html>');
    frameDoc.document.close();
    setTimeout(function () {
        window.frames["frame1"].focus();
        window.frames["frame1"].print();
        document.body.removeChild(frame1);
    }, 500);
    return false;
}

$('body').on('submit','.add_queue_form', function(event){
	event.preventDefault();	
	$.ajax({
		url : "{% url "queue:machine_url"  %}",
		type : "POST",
		dataType: 'html',
		contentType: 'application/x-www-form-urlencoded',
		data:$(this).serialize(),
	})
	.fail(function(xhr){
		var error_message = "AJAX Err:\n";
		error_message += "["+xhr.status.toString()+"] : ";
		error_message += xhr.statusText;
		window.alert(error_message);
	})
	.done(function(data){
	    PrintTicket(data);	    
	});
});

function get_queues(last_queue_id){
	var url="";
	if(last_queue_id){
		url="{% url "queue:booking_list_update_url" services.last.id %}".replace(/{{ services.last.id }}/,last_queue_id);
	}else{
		url="{% url "queue:booking_list_url" %}";
	}
	$.ajax({
		url : url,
		type : "GET",
		dataType: 'html'
	})
	.fail(function(xhr){
		var error_message = "AJAX Err:\n";
		error_message += "["+xhr.status.toString()+"] : ";
		error_message += xhr.statusText;
		window.alert(error_message);
	})
	.done(function(data){
		$('#booking-list-body').append(data)
	});
}

$('body').on('submit','.print-booking-form',function(event){
	event.preventDefault();
	var print_queue_id = $(this).attr('id');
	console.log(print_queue_id);
	$.ajax({
		url : "{% url "queue:booking_print_url" services.last.id %}".replace(/{{ services.last.id }}/,print_queue_id),
		type : "POST",
		dataType: 'html',
		contentType: 'application/x-www-form-urlencoded',
		data:$(this).serialize(),
	})
	.fail(function(xhr){
		var error_message = "AJAX Err:\n";
		error_message += "["+xhr.status.toString()+"] : ";
		error_message += xhr.statusText;
		window.alert(error_message);	
	})
	.done(function(data){
		console.log(data);
	    PrintTicket(data);	    
	});
});


$(document).ready(function(){
	get_queues();
});
this.last_queue_id='';
setInterval(function(){
	var last_queue_id = $('#booking-list-body .list:last-child').children().attr('id');
	this.last_queue_id = last_queue_id;
	get_queues(last_queue_id);
},60*5*1000);

</script>
{% endblock %}


{% block content %}
<div class="wrapper">
    <div class="sidebar-wrapper text-white">
    	<div class="sidebar-panel">
	    	<div class="sidebar-brand">
    			logo CAHAYA
    		</div>
    		<div class="list-header text-right" id="list-header">
    			Booking List
    			<hr class="white">
    		</div>
    		<div id="booking-list-body" class="list-body" >
    		</div>
    	</div>
    </div>
	<a href="#menu-toggle" class="btn btn-secondary sharp tetep" id="menu-toggle">
		<i id="button-icon"class="fa fa-angle-double-right rotate"></i>
	</a>
    <div class="menu page-content-wrapper">
		<table class="content_table">
			{% for service in services %}
			<form class="add_queue_form" id="{{ service.id }}">
				<tr class="content_tr">
					<td class="content_tr">
						{% csrf_token %}
						<input type="hidden" name="service" class="service_name" value="{{ service.id }}"/>
						<input type="hidden" name="print_flag" class="service_name" value="on"/>
						<input type="submit" class="content_button" value="{{ service }}" />
					</td>
				</tr>
			</form>
			{% endfor %}
		</table>
		<div id="section_to_print"></div>
	</div>
</div>
{% endblock %}
